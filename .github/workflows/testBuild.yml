name: Build and deploy apps for testing

on:
  workflow_dispatch:
    inputs:
      pullRequestNumber:
        description: Pull Request number for correct placement of apps
        required: true
  pull_request_target:
    types: [opened, synchronize]

env:
  DEVELOPER_DIR: /Applications/Xcode_14.0.1.app/Contents/Developer

jobs:
  validateActor:
    runs-on: ubuntu-latest
    env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    outputs:
      MERGE_COMMIT: ${{ steps.getCPMergeCommit.outputs.MERGE_COMMIT_SHA }}
    steps:
      - name: Checkout
        uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8
      - id: sth
        run: gh pr checkout ${{ github.event.inputs.pullRequestNumber }}
      - id: getCPMergeCommit
        run: echo "MERGE_COMMIT_SHA=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"


  getBranchHash:
    runs-on: ubuntu-latest
    needs: validateActor
    if: ${{ needs.validateActor.outputs.MERGE_COMMIT }}
    outputs:
      BRANCH_HASH: ${{ steps.get_branch_hash.outputs.BRANCH_NAME_HASH }}
    steps:
      - name: Checkout
        uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8
        with:
          ref: ${{ github.event.pull_request.head.ref || needs.validateActor.outputs.MERGE_COMMIT }}
      - id: get_branch_hash
        uses: staszekscp/App/.github/actions/javascript/hashBranchName@main
        with:
          EVENT_NAME: ${{ github.event_name }}
          PULL_REQUEST_HEAD_REF: ${{ github.event.pull_request.head.ref }}
          REF_NAME: ${{ github.ref_name }}
  
  verifyHash:
    name: Build and deploy Android for testing
    needs: [validateActor, getBranchHash]
    if: ${{ needs.validateActor.outputs.MERGE_COMMIT }}
    runs-on: ubuntu-latest
    env:
      BRANCH_HASH: ${{ needs.getBranchHash.outputs.BRANCH_HASH }}
    steps:
      - id: echoBRANCH_HASH
        run: echo "$BRANCH_HASH"
      - uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Run Fastlane beta test
        id: runFastlaneEcho
        run: bundle exec fastlane android echo
        env:
          S3_ACCESS_KEY: asdadsdsadas
          S3_SECRET_ACCESS_KEY: asddsa
          S3_BUCKET: ad-hoc-expensify-cash
          S3_REGION: us-east-1
      - name: Publish links to apps for download
        run: |
          gh pr comment --body \
          ":test_tube::test_tube: Use the links below to test this build in android and iOS. Happy testing! :test_tube::test_tube:
          https://ad-hoc-expensify-cash.us-east-1.amazonaws.com/desktop/$BRANCH_HASH/NewExpensify.dmg
          ![desktop](https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://ad-hoc-expensify-cash.us-east-1.amazonaws.com/desktop/$BRANCH_HASH/NewExpensify.dmg)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  